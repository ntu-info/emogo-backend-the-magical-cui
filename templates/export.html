<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>EmoGo Data Export</title>
    <style>
      table {
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #000;
        padding: 4px 8px;
      }
      th {
        font-weight: bold;
      }
      #preview-container {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>EmoGo Data Export</h1>

    <button onclick="downloadCSV()">Download CSV</button>
    <button onclick="downloadZip()">Download CSV + Videos (ZIP)</button>

    <table id="data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Timestamp</th>
          <th>Mood</th>
          <th>Latitude</th>
          <th>Longitude</th>
          <th>Download</th>
          <th>Preview</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td>{{ row.id }}</td>
          <td>{{ row.timestamp }}</td>
          <td>{{ row.mood }}</td>
          <td>{{ row.lat }}</td>
          <td>{{ row.lng }}</td>
          <td>
            {% if row.file_url %}
            <a href="{{ row.file_url }}" download>Download</a>
            {% else %} - {% endif %}
          </td>
          <td>
            {% if row.file_url %}
            <a href="#" onclick="previewVideo('{{ row.file_url }}'); return false;">
              Preview
            </a>
            {% else %} - {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div id="preview-container">
      <h2>Video Preview</h2>
      <video
        id="preview-player"
        width="480"
        controls
        style="display: none; border: 1px solid #000;"
      >
        <source id="preview-source" src="" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
    </div>

    <script>
      function previewVideo(url) {
        const video = document.getElementById("preview-player");
        const source = document.getElementById("preview-source");
        source.src = url;
        video.style.display = "block";
        video.load();
        video.play();
      }

      function downloadCSV() {
        const table = document.getElementById("data-table");
        let csv = [];

        for (let i = 0; i < table.rows.length; i++) {
          const row = [];
          const cols = table.rows[i].querySelectorAll("th, td");
          const colCount = cols.length - 2; // 跳過最後兩欄 Download / Preview
          for (let j = 0; j < colCount; j++) {
            let text = cols[j].innerText;
            text = text.replace(/"/g, '""');
            row.push('"' + text + '"');
          }
          csv.push(row.join(","));
        }

        const blob = new Blob([csv.join("\n")], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "emogo_export.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
        function downloadZip() {
            // 直接打後端的 /export-zip，就會觸發下載
            window.location.href = "/export-zip";
        }
    </script>
  </body>
</html>
